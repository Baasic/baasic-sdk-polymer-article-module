<!--
Copyright (c) 2014 Mono d.o.o. All rights reserved.
Code distributed by Mono as a part of the Baasic project
-->

<!--
@group Baasic Polymer Elements

The `baasic-article` element provides displaying Baasic articles. It also includes an editor element that is shown to users in admin roles.

    <baasic-article 
        application="webcomponents" 
        slug="test">
    </baasic-article> 

With `sync` set to `true`, the article element blocks the execution until the content is loaded. `baseUrl`, `version`, and `application` attributes can be set in the globals element for the whole application, and do not have to be set for each individual element.

@element baasic-article
@status beta
@homepage www.baasic.com
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../baasic-ajax/baasic-ajax.html">
<link rel="import" href="../baasic-globals/baasic-globals.html">
<link rel="import" href="../baasic-articleeditor/baasic-articleeditor.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-dialog/paper-dialog-transition.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../core-signals/core-signals.html">
<link rel="import" href="../core-overlay/core-overlay.html">
<link rel="import" href="../core-collapse/core-collapse.html">

<polymer-element name="baasic-article" attributes="baseUrl version application slug sync">
    <template>
        <style>
            :host {
                display: block;
            }
            .article.editor {
                background: #fff;
                padding: 30px;
            }
            .article.footer {
                background: #f5f5f5;
                padding: 20px 30px 20px 30px;
            }
        </style>
        <div id="content"></div>
        <template bind if="{{isAdmin}}">
            <paper-button on-click="{{toggle}}" class="colored">Edit article</paper-button>
            <core-collapse id="collapse">
                <div class="[ article editor ]">
                    <baasic-articleeditor id="articleEditor" application="webcomponents" article="{{article}}" slug="{{slug}}" hideSaveButton="true" on-article-save="{{reload}}"></baasic-articleeditor>
                </div>
                <div class="[ article ] [ footer ]">
                    <paper-button on-click="{{saveArticle}}" affirmative class="colored">Save</paper-button>
                    <paper-button on-click="{{toggle}}">Close</paper-button>
                </div>
            </core-collapse>
        </template>
        <baasic-globals id="globals"></baasic-globals>

        <baasic-ajax id="ajax" 
            url="{{baseUrl}}/{{version}}/{{application}}/article/{{slug}}/"
            params='{"embed":"Authors,Tags"}'
            handleas="json"
            contenttype="application/json"
            response="{{response}}"
            on-core-error="{{onGetError}}"></baasic-ajax>
        <core-signals on-core-signal-user-login="{{loginChanged}}"></core-signals>
    </template>
    <script src="../marked/lib/marked.js"></script>
    <script>
        Polymer('baasic-article', {
            /**
             * The URL target of the Baasic service. Can be used with baasic-globals element to set the property for all baasic elements in one place.
             * 
             * @attribute baseUrl
             * @type string
             * @default ''
             */
            baseUrl: '',
            /**
             * The versione Baasic service. Can be used with baasic-globals element to set the property for all baasic elements in one place.
             * 
             * @attribute version
             * @type string
             * @default ''
             */
            version: '',
            /**
             * The name of the Baasic application, unique per user. Can be used with baasic-globals element to set the property for all baasic elements in one place.
             * 
             * @attribute application
             * @type string
             * @default ''
             */
            application: '',
            /**
             * The slug of the article to display. If an article with this slug doesn't exists, it is created automatically.
             * 
             * @attribute slug
             * @type string
             * @default ''
             */
            slug: '',
            /**
             * Indicator of the syhronous/asynchronous load mode. Set to true if you want to load articles in sync mode, which blocks execution until the content is loaded.
             * 
             * @attribute sync
             * @type boolean
             * @default false
             */
            sync: false,
            isAdmin: false,
            ready: function () {
                this.globals = this.$.globals;
                if (!this.baseUrl) this.baseUrl = this.globals.config.baseUrl;
                if (!this.version) this.version = this.globals.config.version;
                if (!this.application) this.application = this.globals.config.application;
                this.fetchData();
            },
            responseChanged: function (oldValue, newValue) {
                if (newValue != null && oldValue != newValue) {
                    this.article = newValue;
                    this.$.content.innerHTML = marked(this.article.content);
                }
            },
            toggle: function() {
                this.shadowRoot.getElementById('collapse').toggle();
                this.shadowRoot.getElementById('articleEditor').refresh();
            },
            loginChanged: function (data) {
                this.fetchData();
            },
            fetchData: function () {
                this.isAdmin = this.globals.baasicUser.isAdmin;
                if (!this.isAdmin && this.sync)
                    this.$.ajax.xhrArgs = { sync: true };
                else
                    this.$.ajax.xhrArgs = { sync: false };
                this.$.ajax.go();
            },
            onGetError: function (e) {
                this.shadowRoot.getElementById('content').innerHTML = '';
            },
            saveArticle: function (e) {
                this.shadowRoot.getElementById('articleEditor').saveChanges(e);
            },
            reload: function (e) {
                this.shadowRoot.getElementById('content').innerHTML = marked(e.detail.content);
            }
        });
    </script>
</polymer-element>
